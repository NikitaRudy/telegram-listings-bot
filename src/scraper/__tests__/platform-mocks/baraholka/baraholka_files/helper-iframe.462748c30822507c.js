!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c||a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";var d=a("./helper-iframe/GeneralHelperIframe"),e=a("./helper-iframe/WebPushHelperIframe");!function(){var a=new d,b=new e;window.onmessage=function(c){a.messageHandler(c),b.messageHandler(c)}}()},{"./helper-iframe/GeneralHelperIframe":2,"./helper-iframe/WebPushHelperIframe":3}],2:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=function(){function a(){d(this,a)}return e(a,[{key:"messageHandler",value:function(a){var b=a.data||{};switch(b.type){case"chats-helper:general:is-auth":this.handleIsAuth(b)}}},{key:"handleIsAuth",value:function(a){a.isAuth||this.clearLocalStorage()}},{key:"clearLocalStorage",value:function(){Object.keys(localStorage).forEach(function(a){a.match(/^chat-web-push-/)||localStorage.removeItem(a)})}}]),a}();b.exports=f},{}],3:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=a("../services/web-push-service"),g=function(){function a(){d(this,a)}return e(a,[{key:"postMessageToParent",value:function(a){window.parent.postMessage(a,"*")}},{key:"postSubscribed",value:function(a){this.postMessageToParent({type:"chats-helper-iframe:web-push:subscribed",subscription:a})}},{key:"postNotificationClicked",value:function(a){this.postMessageToParent({type:"chats-helper-iframe:web-push:notification_clicked",data:a})}},{key:"messageHandler",value:function(a){switch((a.data||{}).type){case"chats-helper:web-push:subscribe":this.handleSubscribe();break;case"chats-helper:web-push:unsubscribe":this.handleUnsubscribe();break;case"chats-helper:web-push:activate-silent":this.handleActivateSilent();break;case"chats-helper:web-push:deactivate-silent":this.handleDeactivateSilent()}}},{key:"handleSubscribe",value:function(){var a=this;f.isAvailable&&"granted"===Notification.permission&&(f.addCallback("init",function(a){a||f.subscribe()}),f.addCallback("subscribe",function(b){b&&a.postSubscribed(b)}),f.addCallback("notification_click",function(b){a.postNotificationClicked(b)}),f.start())}},{key:"handleUnsubscribe",value:function(){f.forceUnsubscribe(),f.hidePushNotifications()}},{key:"handleActivateSilent",value:function(){setTimeout(function(){f.activateSilent()},0)}},{key:"handleDeactivateSilent",value:function(){f.deactivateSilent()}}]),a}();b.exports=g},{"../services/web-push-service":4}],4:[function(a,b,c){"use strict";function d(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var f=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),g=void 0,h=function(){function a(){e(this,a),this.isAvailable=!0,this.isPushEnabled=!1,this._publicKey=window.WEBPUSH_PUBLIC_KEY,this._callbacks={init:[],subscribe:[],unsubscribe:[],notification_click:[]},this._started=!1,"PushManager"in window&&"Notification"in window&&"serviceWorker"in navigator||(console.warn("[WebPushService]: Push messaging is not supported."),this.isAvailable=!1),this.isAvailable&&"denied"===Notification.permission&&console.warn("[WebPushService]: The user has blocked notifications.")}return f(a,[{key:"addCallback",value:function(a,b){this._callbacks[a]&&b&&this._callbacks[a].push(b)}},{key:"_executeCallbacks",value:function(a,b){(this._callbacks[a]||[]).forEach(function(a){a(b)})}},{key:"start",value:function(){this._started||(this._started=!0,this._getInitialSubscription(),this._setUpServiceWorkerChannel())}},{key:"activateSilent",value:function(){if(this.isAvailable&&navigator.serviceWorker.controller){var a={type:"notifications_activate_silent"};navigator.serviceWorker.controller.postMessage(a)}}},{key:"deactivateSilent",value:function(){if(this.isAvailable&&navigator.serviceWorker.controller){var a={type:"notifications_deactivate_silent"};navigator.serviceWorker.controller.postMessage(a)}}},{key:"subscribe",value:function(){var b=this;this.isAvailable&&navigator.serviceWorker.ready.then(function(c){var d={userVisibleOnly:!0,applicationServerKey:a.urlBase64ToUint8Array(b._publicKey)};c.pushManager.subscribe(d).then(function(a){b.isPushEnabled=!0,b._pushSubscriptionNotify("subscribe",a)}).catch(function(){b._pushSubscriptionNotify("subscribe")})})}},{key:"unsubscribe",value:function(){var a=this;this.isAvailable&&navigator.serviceWorker.ready.then(function(b){b.pushManager.getSubscription().then(function(b){a.isPushEnabled=!1,b&&(a._pushSubscriptionNotify("unsubscribe",b),setTimeout(function(){b.unsubscribe().then(function(b){a.isPushEnabled=!1,console.log("[WebPushService]: Unsubscribe successful",b)}).catch(function(a){console.error("[WebPushService]: Unsubscription error.",a)})},3e3))}).catch(function(a){console.log("[WebPushService]: Unsubscribe: Error thrown while unsubscribing from push messaging.",a)})})}},{key:"forceUnsubscribe",value:function(){var a=this;this.isAvailable&&navigator.serviceWorker.ready.then(function(b){b.pushManager.getSubscription().then(function(b){b&&b.unsubscribe().then(function(b){a.isPushEnabled=!1,console.warn("[WebPushService]: Force unsubscribe successful",b)}).catch(function(a){console.error("[WebPushService]: Force unsubscribe error.",a)})}).catch(function(a){console.log("[WebPushService]: Force unsubscribe: Error thrown while unsubscribing from push messaging.",a)})})}},{key:"hidePushNotifications",value:function(){if(this.isAvailable&&navigator.serviceWorker.controller){var a={type:"notifications_clear"};navigator.serviceWorker.controller.postMessage(a)}}},{key:"_getInitialSubscription",value:function(){var a=this;this.isAvailable&&navigator.serviceWorker.ready.then(function(b){b.pushManager.getSubscription().then(function(b){a.isPushEnabled=!!b,a._pushSubscriptionNotify("init",b)}).catch(function(a){console.log("[WebPushService]: getSubscription error. ",a)})})}},{key:"_setUpServiceWorkerChannel",value:function(){var a=this;this.isAvailable&&navigator.serviceWorker.addEventListener("message",function(b){b.data&&"push_click"===b.data.type&&a._executeCallbacks("notification_click",b.data.data)})}},{key:"_pushSubscriptionNotify",value:function(a,b){if(b){var c=b.toJSON();if(!(c&&c.endpoint&&c.keys&&c.keys.p256dh&&c.keys.auth))return console.warn("[WebPushService]: Invalid push subscription",c),this.unsubscribe(),this.isAvailable=!1,this._pushSubscriptionNotify(a,!1);this._executeCallbacks(a,c)}else this._executeCallbacks(a,!1)}}],[{key:"urlBase64ToUint8Array",value:function(a){var b="=".repeat((4-a.length%4)%4),c=(a+b).replace(/\-/g,"+").replace(/_/g,"/"),e=window.atob(c);return Uint8Array.from([].concat(d(e)).map(function(a){return a.charCodeAt(0)}))}},{key:"_getInstance",value:function(){return g=g||new a}}]),a}();b.exports=h._getInstance()},{}]},{},[1]);